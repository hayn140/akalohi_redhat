---
# tasks file for export_ec2_to_vhd

- name: Install python
  ansible.builtin.package:
    name: python3-pip
    state: latest

- name: Install boto3 and botocore (AWS SDK)
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
    executable: pip3

- name: Uninstall yum awscli
  ansible.builtin.package:
    name: awscli
    state: absent

- name: Install pip awscli
  ansible.builtin.pip:
    name: awscli
    executable: pip3

- name: Export EC2 Instance to VHD
  ec2_export_instance:
    instance_id: "{{ ec2_instance_id }}"
    disk_image_format: "{{ disk_image_format }}"
    s3_bucket: "{{ s3_bucket_name }}" 
    s3_prefix: "{{ s3_bucket_path }}"
    target_environment: "{{ target_environment }}"
    region: "{{ aws_region }}"
  become: false
  register: export_filename

- name: Display exported image filename
  ansible.builtin.debug:
    msg: "VHD Filename: {{ export_filename.export_task_id }}.vhd"

- name: Set exported filename as fact
  ansible.builtin.set_fact:
    vhd_full_pathname: "{{ s3_bucket_path }}{{ export_filename.export_task_id }}.vhd"

# - name: Wait, Check every 30 seconds for 60 minutes until vmdk appears in S3 bucket
#   amazon.aws.s3_object_info:
#     aws_region: "{{ aws_region }}"
#     bucket_name: "{{ s3_bucket_name }}"
#     object_name: "{{ vmdk_full_pathname }}"
#     access_key: "{{ aws_access_key }}"
#     secret_key: "{{ aws_secret_key }}"
#   register: s3_check
#   retries: 120
#   delay: 30
#   until: s3_check.object_info[0].object_data is defined
#   ignore_errors: false
#   delegate_to: localhost

# - name: Terminate EC2 Instance
#   amazon.aws.ec2_instance:
#     instance_ids:
#       - "{{ ec2_instance_id }}"
#     region: "{{ aws_region }}"
#     state: terminated
#     access_key: "{{ aws_access_key }}"
#     secret_key: "{{ aws_secret_key }}"
#     wait: true
#   delegate_to: localhost
